<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programme TV TNT</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f0f0f0;
}

/* TIMELINE */
.timeline {
    display: flex;
    background: #fff;
    border-bottom: 1px solid #ccc;
    position: sticky;
    top: 0;
    z-index: 10;
}

.hour-mark {
    min-width: 100px;
    border-right: 1px solid #ddd;
    padding: 5px;
    text-align: center;
}

/* SCROLL GLOBAL */
#scrollzone {
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
}

/* LIGNE CHA√éNE */
.channel-row {
    display: flex;
    align-items: stretch;
}

/* LABEL CHA√éNE */
.channel-label {
    width: 180px;
    min-width: 180px;
    padding: 10px;
    background: #fff;
    border-right: 1px solid #ccc;
    border-bottom: 1px solid #ccc;
    position: sticky;
    left: 0;
    z-index: 5;
    font-weight: bold;
}

/* PROGRAMME */
.program {
    border: 1px solid #3333;
    color: #fff;
    padding: 8px;
    margin: 1px;
    white-space: normal;
    height: 45px;
    overflow: hidden;
    cursor: pointer;
    display: inline-block;

    /* ESSENTIEL : Emp√™che flex de modifier la largeur */
    flex-shrink: 0;
    flex-grow: 0;
    flex-basis: auto;
}

/* Mobile */
@media (max-width:600px) {
    .hour-mark { min-width: 70px; font-size: 10px; }
    .channel-label { width: 120px; min-width:120px; font-size:12px; }
    .program { font-size:11px; height:36px; padding:5px; }
}

/* Bouton maintenant */
#now-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 999;
    padding: 10px 15px;
    border-radius: 8px;
    background: #4a6f96;
    color: white;
    border: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    cursor: pointer;
}
</style>
</head>
<body>

<h1 style="text-align:center;">Programme TV ‚Äì TNT</h1>

<button id="now-btn" onclick="scrollToNow()">‚è± Maintenant</button>

<div id="scrollzone">
    <div class="timeline" id="timeline"></div>
    <div id="epg-grid"></div>
</div>

<script>
const XMLTV_URL = "./xmltv_tnt.xml";
const PIXELS_PER_MINUTE = 2;
const START_HOUR = 6;
const END_HOUR = 24;

/* Couleurs / emojis */
const CATEGORY_STYLE = {
    "Film": {emoji:"üé¨",color:"#2d4a7c"},
    "S√©rie": {emoji:"üì∫",color:"#5b3c78"},
    "Information": {emoji:"üì∞",color:"#7c2d2d"},
    "Talk": {emoji:"üí¨",color:"#8c4c1b"},
    "Divertissement": {emoji:"üé≠",color:"#8c1b6a"},
    "Jeunesse": {emoji:"üë∂",color:"#4c7c2d"},
    "Sport": {emoji:"‚öΩ",color:"#1b6a2d"},
    "Documentaire": {emoji:"üìö",color:"#6a4c2d"}
};

function getStyleFromCategory(cat){
    if(!cat) return {emoji:"‚ùì",color:"#555"};
    for(let key in CATEGORY_STYLE){
        if(cat.toLowerCase().includes(key.toLowerCase()))
            return CATEGORY_STYLE[key];
    }
    return {emoji:"‚ùì",color:"#555"};
}

/* INIT */
async function init(){
    const timeline = document.getElementById("timeline");
    for(let i=START_HOUR;i<END_HOUR;i++){
        timeline.innerHTML += `<div class="hour-mark">${i}h00</div>`;
    }

    const data = await getEPG();
    if(data) render(data);
}

/* FETCH XMLTV */
async function getEPG(){
    try{
        const response = await fetch(XMLTV_URL);
        const text = await response.text();
        const xml = new DOMParser().parseFromString(text,"text/xml");

        const channels = {};
        const progs = xml.querySelectorAll("programme");

        progs.forEach(p=>{
            const ch = p.getAttribute("channel");
            if(!channels[ch]) channels[ch]=[];

            const start = parseDate(p.getAttribute("start"));
            const stop  = parseDate(p.getAttribute("stop"));
            const duration = (stop - start)/60000;

            if(start.getHours() < START_HOUR) return;

            const category = p.querySelector("category")?.textContent || "";

            channels[ch].push({
                title: p.querySelector("title")?.textContent || "",
                desc: p.querySelector("desc")?.textContent || "",
                category,
                duration,
                start: (start.getHours() - START_HOUR)*60 + start.getMinutes()
            });
        });

        return channels;

    }catch(e){
        document.getElementById("epg-grid").innerText="Erreur chargement TV";
        return null;
    }
}

/* Parse date XMLTV */
function parseDate(str){
    const y=str.substring(0,4), m=str.substring(4,6), d=str.substring(6,8);
    const hh=str.substring(8,10), mm=str.substring(10,12), ss=str.substring(12,14);
    const tz=str.substring(15,18)+":"+str.substring(18);
    return new Date(`${y}-${m}-${d}T${hh}:${mm}:${ss}${tz}`);
}

/* RENDER */
function render(data){
    const grid=document.getElementById("epg-grid");
    grid.innerHTML="";

    Object.keys(data).forEach(ch=>{
        let row = `<div class="channel-row">
            <div class="channel-label">${ch}</div>`;

        data[ch].forEach(p=>{
            const style = getStyleFromCategory(p.category);

            row += `
            <div class="program"
                 style="width:${p.duration*PIXELS_PER_MINUTE}px; background:${style.color};"
                 onclick="showDetails('${escapeJS(p.title)}','${escapeJS(p.desc)}')">
                ${style.emoji} ${p.title}
            </div>`;
        });

        row += "</div>";
        grid.innerHTML += row;
    });
}

/* D√âTAILS DU PROGRAMME */
function escapeJS(s){
    return s.replace(/'/g,"\\'");
}

function showDetails(title,desc){
    alert(title + "\n\n" + desc);
}

/* BOUTON MAINTENANT */
function scrollToNow(){
    const now=new Date();
    let minutes=(now.getHours()-START_HOUR)*60 + now.getMinutes();
    if(minutes<0) minutes=0;

    document.getElementById("scrollzone").scrollTo({
        left: minutes*PIXELS_PER_MINUTE,
        behavior:"smooth"
    });
}

init();
</script>

</body>
</html>
