
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNT Guide Pro - Portable</title>
    <!-- Tailwind CSS pour le style -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel pour compiler le JSX dans le navigateur -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0b0f1a; color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "@google/genai": "https://esm.sh/@google/genai@1.39.0",
        "lucide-react": "https://esm.sh/lucide-react@0.474.0"
      }
    }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI, Type } from "@google/genai";
        import { 
          Tv, Search, Calendar, Clock, Sun, Sunrise, Sunset, Sparkles, 
          RefreshCcw, LayoutGrid, List, Settings2, X, Share2, Play,
          Film, Clapperboard, Info, Newspaper, Trophy, Mic2, Baby, HelpCircle,
          GripVertical, ChevronUp, ChevronDown, Eye, EyeOff
        } from 'lucide-react';

        // --- CONFIG & CONSTANTES ---
        const CATEGORIES = ['All', 'Film', 'Série', 'Documentaire', 'Information', 'Sport', 'Divertissement', 'Jeunesse'];
        const CACHE_KEY = 'tnt_guide_data';
        const CACHE_TS_KEY = 'tnt_guide_timestamp';
        const CACHE_TOMORROW_KEY = 'tnt_guide_tomorrow_data';
        const CACHE_TOMORROW_DATE_KEY = 'tnt_guide_tomorrow_date';
        const PREFS_KEY = 'tnt_channel_prefs';

        const CATEGORY_ICONS = {
          'Film': { icon: Film, color: 'text-amber-400', bg: 'bg-amber-400/10' },
          'Série': { icon: Clapperboard, color: 'text-purple-400', bg: 'bg-purple-400/10' },
          'Documentaire': { icon: Info, color: 'text-emerald-400', bg: 'bg-emerald-400/10' },
          'Information': { icon: Newspaper, color: 'text-blue-400', bg: 'bg-blue-400/10' },
          'Sport': { icon: Trophy, color: 'text-orange-400', bg: 'bg-orange-400/10' },
          'Divertissement': { icon: Mic2, color: 'text-pink-400', bg: 'bg-pink-400/10' },
          'Jeunesse': { icon: Baby, color: 'text-cyan-400', bg: 'bg-cyan-400/10' },
          'Autre': { icon: HelpCircle, color: 'text-slate-400', bg: 'bg-slate-400/10' },
        };

        // --- UTILS ---
        const parseTimeToMinutes = (timeStr) => {
          if (!timeStr) return 0;
          const match = timeStr.match(/(\d{1,2})[:h](\d{2})/i);
          return match ? parseInt(match[1], 10) * 60 + parseInt(match[2], 10) : 0;
        };

        const formatDisplayTime = (timeStr) => {
          if (!timeStr) return '';
          const match = timeStr.match(/(\d{1,2})[:h](\d{2})/i);
          return match ? `${match[1].padStart(2, '0')}:${match[2]}` : timeStr;
        };

        // --- API SERVICE ---
        const fetchTVPrograms = async (daysOffset = 0) => {
          const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
          const targetDate = new Date();
          targetDate.setDate(targetDate.getDate() + daysOffset);
          const dateStr = targetDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
          
          const prompt = `Génère la grille TV TNT française complète pour le ${dateStr}. Format JSON. 
          Chainès (N°): TF1(1) à Chérie 25(25).`;

          const response = await ai.models.generateContent({
            model: "gemini-3-flash-preview",
            contents: prompt,
            config: {
              tools: [{ googleSearch: {} }],
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.ARRAY,
                items: {
                  type: Type.OBJECT,
                  properties: {
                    name: { type: Type.STRING },
                    number: { type: Type.INTEGER },
                    programs: {
                      type: Type.ARRAY,
                      items: {
                        type: Type.OBJECT,
                        properties: {
                          title: { type: Type.STRING },
                          startTime: { type: Type.STRING },
                          endTime: { type: Type.STRING },
                          category: { type: Type.STRING },
                          description: { type: Type.STRING }
                        },
                        required: ["title", "startTime", "endTime", "category", "description"]
                      }
                    }
                  },
                  required: ["name", "programs", "number"]
                }
              }
            }
          });

          const data = JSON.parse(response.text.trim());
          return data.map(channel => ({
            ...channel,
            id: channel.number,
            programs: channel.programs.map((prog, idx) => ({
              ...prog,
              id: `${channel.number}-${idx}-${targetDate.getTime()}`,
              channelName: channel.name,
              channelNumber: channel.number
            }))
          }));
        };

        // --- COMPOSANTS INTERNES ---
        const ProgramCard = ({ program, onClick, currentTimeMinutes }) => {
          const cat = CATEGORY_ICONS[program.category] || CATEGORY_ICONS['Autre'];
          const Icon = cat.icon;
          const isLive = useMemo(() => {
            const s = parseTimeToMinutes(program.startTime);
            let e = parseTimeToMinutes(program.endTime);
            if (e < s) e += 1440;
            return currentTimeMinutes >= s && currentTimeMinutes < e;
          }, [program.startTime, program.endTime, currentTimeMinutes]);

          const progress = useMemo(() => {
            if (!isLive) return 0;
            const s = parseTimeToMinutes(program.startTime);
            let e = parseTimeToMinutes(program.endTime);
            if (e < s) e += 1440;
            return Math.min(Math.max(((currentTimeMinutes - s) / (e - s)) * 100, 0), 100);
          }, [isLive, program.startTime, program.endTime, currentTimeMinutes]);

          return (
            <div className="group flex bg-slate-800/40 border border-slate-700/50 rounded-xl overflow-hidden hover:bg-slate-800/60 hover:border-indigo-500/50 transition-all cursor-pointer shadow-lg" onClick={() => onClick(program)}>
              <div className="w-16 md:w-28 flex flex-col items-center justify-center p-2 bg-slate-900/40 border-r border-slate-700/50">
                <span className="text-[9px] font-black text-slate-500 uppercase text-center mb-1">{program.channelName}</span>
                <span className="text-xl md:text-2xl font-black text-white">{program.channelNumber}</span>
              </div>
              <div className="flex-1 p-4 min-w-0">
                <div className="flex items-center gap-3 mb-2">
                  <span className="text-lg md:text-2xl font-black text-indigo-400">{formatDisplayTime(program.startTime)}</span>
                  {isLive && (
                    <div className="flex-1 h-1.5 bg-slate-900/60 rounded-full overflow-hidden border border-white/5">
                      <div className="h-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.6)]" style={{ width: `${progress}%` }}></div>
                    </div>
                  )}
                </div>
                <h3 className="text-sm md:text-lg font-bold text-white truncate group-hover:text-indigo-300">
                  {program.title} {isLive && <span className="ml-2 inline-block px-1.5 py-0.5 rounded-full bg-red-600 text-[8px] font-black uppercase text-white animate-pulse">Direct</span>}
                </h3>
                <p className="text-slate-400 text-xs truncate mt-1">{program.description}</p>
              </div>
              <div className="hidden md:flex w-24 items-center justify-center p-4">
                <div className={`p-3 rounded-xl ${cat.bg}`}><Icon className={`w-6 h-6 ${cat.color}`} /></div>
              </div>
            </div>
          );
        };

        const App = () => {
          const [channels, setChannels] = useState([]);
          const [loading, setLoading] = useState(false);
          const [searchQuery, setSearchQuery] = useState('');
          const [activeCategory, setActiveCategory] = useState('All');
          const [selectedProgram, setSelectedProgram] = useState(null);
          const [timeRange, setTimeRange] = useState([0, 1440]);
          const [showSettings, setShowSettings] = useState(false);
          const [channelPrefs, setChannelPrefs] = useState([]);
          const [currentTimeMinutes, setCurrentTimeMinutes] = useState(() => {
            const n = new Date(); return n.getHours() * 60 + n.getMinutes();
          });

          useEffect(() => {
            const i = setInterval(() => {
              const n = new Date(); setCurrentTimeMinutes(n.getHours() * 60 + n.getMinutes());
            }, 30000);
            return () => clearInterval(i);
          }, []);

          const prefetchTomorrow = useCallback(async () => {
            const tom = new Date(); tom.setDate(tom.getDate() + 1);
            const tomStr = tom.toDateString();
            if (localStorage.getItem(CACHE_TOMORROW_DATE_KEY) === tomStr) return;
            try {
              const d = await fetchTVPrograms(1);
              localStorage.setItem(CACHE_TOMORROW_KEY, JSON.stringify(d));
              localStorage.setItem(CACHE_TOMORROW_DATE_KEY, tomStr);
            } catch (e) {}
          }, []);

          const loadData = useCallback(async () => {
            setLoading(true);
            try {
              const d = await fetchTVPrograms(0);
              setChannels(d);
              setChannelPrefs(prev => {
                const n = [...prev];
                d.forEach(c => { if (!n.find(p => p.name === c.name)) n.push({ name: c.name, visible: true, order: c.number || n.length }); });
                localStorage.setItem(PREFS_KEY, JSON.stringify(n));
                return n;
              });
              localStorage.setItem(CACHE_KEY, JSON.stringify(d));
              localStorage.setItem(CACHE_TS_KEY, Date.now().toString());
              prefetchTomorrow();
            } catch (e) { console.error(e); } finally { setLoading(false); }
          }, [prefetchTomorrow]);

          useEffect(() => {
            const todayStr = new Date().toDateString();
            const savedData = localStorage.getItem(CACHE_KEY);
            const savedTs = localStorage.getItem(CACHE_TS_KEY);
            const tomData = localStorage.getItem(CACHE_TOMORROW_KEY);
            const tomDate = localStorage.getItem(CACHE_TOMORROW_DATE_KEY);
            const savedPrefs = localStorage.getItem(PREFS_KEY);

            if (savedPrefs) setChannelPrefs(JSON.parse(savedPrefs));
            
            if (tomData && tomDate === todayStr) {
              setChannels(JSON.parse(tomData));
              localStorage.setItem(CACHE_KEY, tomData);
              localStorage.setItem(CACHE_TS_KEY, Date.now().toString());
              localStorage.removeItem(CACHE_TOMORROW_KEY);
              prefetchTomorrow();
              return;
            }
            if (savedData && savedTs && new Date(parseInt(savedTs)).toDateString() === todayStr) {
              setChannels(JSON.parse(savedData));
              prefetchTomorrow();
              return;
            }
            loadData();
          }, [loadData, prefetchTomorrow]);

          const filtered = useMemo(() => {
            const visible = channelPrefs.filter(p => p.visible).map(p => p.name);
            return channels
              .filter(c => visible.includes(c.name))
              .flatMap(c => c.programs)
              .filter(p => {
                if (activeCategory !== 'All' && p.category !== activeCategory) return false;
                if (searchQuery && !p.title.toLowerCase().includes(searchQuery.toLowerCase())) return false;
                const start = parseTimeToMinutes(p.startTime);
                return start >= timeRange[0] && start <= timeRange[1];
              })
              .sort((a, b) => {
                const oa = channelPrefs.find(p => p.name === a.channelName)?.order ?? 99;
                const ob = channelPrefs.find(p => p.name === b.channelName)?.order ?? 99;
                if (oa !== ob) return oa - ob;
                return parseTimeToMinutes(a.startTime) - parseTimeToMinutes(b.startTime);
              });
          }, [channels, channelPrefs, activeCategory, searchQuery, timeRange]);

          return (
            <div className="min-h-screen pb-10">
              <header className="sticky top-0 z-50 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 px-6 py-4 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="bg-indigo-600 p-2 rounded-lg"><Tv className="w-6 h-6" /></div>
                  <h1 className="text-xl font-bold">TNT Guide Pro</h1>
                </div>
                <div className="flex-1 max-w-md mx-8 relative">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                  <input type="text" placeholder="Rechercher..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full bg-slate-800/50 border border-slate-700 rounded-full py-2 pl-10 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/40" />
                </div>
                <button onClick={() => setShowSettings(true)} className="p-2 bg-slate-800 rounded-xl"><Settings2 className="w-5 h-5" /></button>
              </header>

              <main className="max-w-6xl mx-auto px-6 py-8 space-y-8">
                <div className="flex items-center gap-3 overflow-x-auto pb-2 no-scrollbar">
                  {CATEGORIES.map(cat => (
                    <button key={cat} onClick={() => setActiveCategory(cat)} className={`px-5 py-2 rounded-full text-[10px] font-black uppercase tracking-widest border transition-all ${activeCategory === cat ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-slate-800/40 border-slate-700 text-slate-400'}`}>
                      {cat === 'All' ? 'Tous' : cat}
                    </button>
                  ))}
                </div>

                {loading && channels.length === 0 ? (
                  <div className="py-40 flex flex-col items-center justify-center text-slate-500 animate-pulse"><RefreshCcw className="w-12 h-12 animate-spin mb-4" /><p>Chargement...</p></div>
                ) : (
                  <div className="flex flex-col gap-4">
                    {filtered.map(p => (
                      <ProgramCard key={p.id} program={p} onClick={setSelectedProgram} currentTimeMinutes={currentTimeMinutes} />
                    ))}
                  </div>
                )}
              </main>

              {selectedProgram && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                  <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setSelectedProgram(null)}></div>
                  <div className="relative bg-slate-900 border border-slate-800 w-full max-w-xl rounded-2xl p-8 shadow-2xl animate-in zoom-in duration-200">
                    <button onClick={() => setSelectedProgram(null)} className="absolute top-4 right-4 text-slate-400"><X /></button>
                    <h2 className="text-2xl font-black mb-2">{selectedProgram.title}</h2>
                    <div className="flex items-center gap-4 text-sm text-indigo-400 font-bold mb-6">
                      <span className="bg-slate-800 px-3 py-1 rounded-md">{selectedProgram.channelName} (Canal {selectedProgram.channelNumber})</span>
                      <span>{selectedProgram.startTime} - {selectedProgram.endTime}</span>
                    </div>
                    <p className="text-slate-300 leading-relaxed mb-8">{selectedProgram.description}</p>
                    <button className="w-full bg-white text-black font-black py-4 rounded-xl flex items-center justify-center gap-2 hover:bg-indigo-50 transition-all"><Play className="fill-black" /> REGARDER</button>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
