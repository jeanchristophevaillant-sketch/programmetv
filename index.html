<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programme TV TNT</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f5f5f5;
}

h1 {
    text-align: center;
    padding: 15px;
}

/* TIMELINE */
.timeline {
    display: flex;
    background: #333;
    color:white;
    border-bottom: 1px solid #ccc;
    position: sticky;
    top: 0;
    z-index: 10;
    margin-left: 200px;
}
.hour-mark {
    min-width: 100px;
    text-align: center;
    padding: 5px;
    font-size: 14px;
    border-right: 1px solid #eee;
}

/* SCROLL GLOBAL (timeline + programmes) */
#scrollzone {
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
}



/* LABEL CHAÎNE */
.channel-label {
    width: 180px;
    min-width: 180px;
    background: #fff;
    padding: 10px;
    font-weight: bold;
    border-right: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    position: sticky;
    left: 0;
    z-index: 10;
}
.channel-row:nth-child(odd) .program {
    background-color: #ffffff; /* blanc */
}

.channel-row:nth-child(even) .program {
    background-color: #f7f7f7; /* gris très léger */
}


/* PROGRAMME (sans couleurs maintenant) */
.channel-row {
    position: relative;
    height: 45px;
    border-bottom: 1px solid #eee;
    overflow: visible;      /* <-- IMPORTANT */
}

.program {
    position: absolute;
    top: 0;
    height: 100%;
    border: 1px solid #ddd;
    background: #fff;
    padding: 4px 6px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    cursor: pointer;
    z-index: 5;             /* <-- POUR PASSER DEVANT LE LABEL */
}


/* Titre sur 1 seule ligne + … */
.prog-title {
    font-size: 13px;
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Petites heures */
.prog-time {
    font-size: 10px;
    color: #666;
    margin-top: 2px;
}

/* POPUP DÉTAIL MODERNE */
#popup-bg {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 999;
}

#popup {
    background: #fff;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    padding: 20px;
    max-height: 90vh;
    overflow-y: auto;
}

#popup img {
    width: 100%;
    border-radius: 6px;
    margin-bottom: 10px;
}

#popup h2 {
    margin-top: 0;
}

#close-btn {
    float: right;
    cursor: pointer;
    font-size: 20px;
    margin-top: -10px;
}

/* Mobile */
@media (max-width:600px){
    .hour-mark { min-width: 60px; font-size: 10px; }
    .channel-label { width:120px; min-width:120px; font-size:12px; }
    .program { height:38px; padding:3px; }
    .prog-title { font-size:12px; }
}

/* Bouton maintenant */
#now-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 10px 15px;
    border-radius: 8px;
    background: #4a6f96;
    color: white;
    border: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    cursor: pointer;
    z-index: 900;
}
</style>
</head>
<body>

<h1>Programme TV – TNT</h1>
<button id="now-btn" onclick="scrollToNow()">⏱ Maintenant</button>

<div id="scrollzone">
    <div class="timeline" id="timeline"></div>
    <div id="epg-grid"></div>
</div>

<!-- POPUP DETAIL -->
<div id="popup-bg" onclick="closePopup()">
    <div id="popup" onclick="event.stopPropagation();">
        <span id="close-btn" onclick="closePopup()">✖</span>
        <div id="popup-content"></div>
    </div>
</div>

<script>
// ------------------ CONFIG --------------------
const CHANNEL_LABEL_WIDTH = 180; // même valeur que dans ton CSS
const XMLTV_URL = "./xmltv_tnt.xml";
const PIXELS_PER_MINUTE = 2;
const START_HOUR = 6;
const END_HOUR = 24;

// ----------------------------------------------
function init(){
    const timeline = document.getElementById("timeline");
    for(let h=START_HOUR; h<END_HOUR; h++){
        timeline.innerHTML += `<div class="hour-mark">${h}h00</div>`;
    }
    loadXML();
}

// ------------------ CHARGEMENT XMLTV --------------------
async function loadXML(){
    try{
        const txt = await (await fetch(XMLTV_URL)).text();
        const xml = new DOMParser().parseFromString(txt,"text/xml");

        const channels = {};
        xml.querySelectorAll("programme").forEach(p=>{
            const ch = p.getAttribute("channel");
            if(!channels[ch]) channels[ch]=[];

            const start = parseDate(p.getAttribute("start"));
            const stop  = parseDate(p.getAttribute("stop"));
            if(start.getHours()<START_HOUR) return;

            const duration = (stop-start)/60000;

            const icon = p.querySelector("icon")?.getAttribute("src") || null;

            channels[ch].push({
                title: p.querySelector("title")?.textContent || "",
                desc: p.querySelector("desc")?.textContent || "",
                category: p.querySelector("category")?.textContent || "",
                icon,
                start,
                stop,
                duration
            });
        });

        render(channels);

    } catch(e){
        document.getElementById("epg-grid").innerText = "Erreur : données TV indisponibles";
    }
}

// ------------------ PARSE DATE --------------------
function parseDate(s){
    const y=s.slice(0,4), m=s.slice(4,6), d=s.slice(6,8);
    const hh=s.slice(8,10), mm=s.slice(10,12), ss=s.slice(12,14);
    const tz=s.slice(15,18)+":"+s.slice(18);
    return new Date(`${y}-${m}-${d}T${hh}:${mm}:${ss}${tz}`);
}

// ------------------ AFFICHAGE --------------------
function render(data){
    const grid = document.getElementById("epg-grid");
    grid.innerHTML="";

    Object.keys(data).forEach(ch=>{
        let html = `<div class="channel-row">
            <div class="channel-label">${ch}</div>
        `;

        data[ch].forEach(p=>{
            const startMin = (p.start.getHours()-START_HOUR)*60 + p.start.getMinutes();
            const width = p.duration * PIXELS_PER_MINUTE;
            const startStr = p.start.toLocaleTimeString("fr-FR",{hour:'2-digit',minute:'2-digit'});
            const stopStr  = p.stop.toLocaleTimeString("fr-FR",{hour:'2-digit',minute:'2-digit'});

            html += `
                <div class="program"
                    style="
                        left:${CHANNEL_LABEL_WIDTH + startMin * PIXELS_PER_MINUTE}px;
                        width:${width}px;
                    "
                    onclick='showPopup(
                        ${JSON.stringify(p.start)},
                        ${JSON.stringify(p.stop)},
                        "${escapeHTML(p.title)}",
                        "${escapeHTML(p.desc)}",
                        "${escapeHTML(p.category)}",
                        "${p.icon}"
                    )'>
                    <div class="prog-title">${p.title}</div>
                    <div class="prog-time">${startStr} – ${stopStr}</div>
                </div>`;

        });

        html += `</div>`;
        grid.innerHTML += html;
    });
}

// ------------------ POPUP DETAIL --------------------
function showPopup(start,stop,title,desc,category,icon){
    const st = new Date(start);
    const sp = new Date(stop);

    const hour = st.toLocaleTimeString("fr-FR",{hour:'2-digit',minute:'2-digit'})
               + " – "
               + sp.toLocaleTimeString("fr-FR",{hour:'2-digit',minute:'2-digit'});

    let html = `<h2>${title}</h2>
                <p><strong>Type :</strong> ${category || "Non précisé"}</p>
                <p><strong>Horaire :</strong> ${hour}</p>`;

    if(icon) html += `<img src="${icon}" alt="Image programme">`;

    html += `<p>${desc || "Aucune description."}</p>`;

    document.getElementById("popup-content").innerHTML = html;
    document.getElementById("popup-bg").style.display = "flex";
}

function closePopup(){
    document.getElementById("popup-bg").style.display = "none";
}

// ------------------ BOUTON MAINTENANT --------------------
function scrollToNow(){
    const now=new Date();
    let minutes=(now.getHours()-START_HOUR)*60 + now.getMinutes();
    if(minutes<0) minutes=0;

    document.getElementById("scrollzone").scrollTo({
        left: minutes*PIXELS_PER_MINUTE,
        behavior:"smooth"
    });
}

// ESCAPE HTML
function escapeHTML(str){
    return str.replace(/"/g,'&quot;').replace(/'/g,"&#39;");
}

init();
</script>
<script>
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
}
</script>


</body>
</html>
