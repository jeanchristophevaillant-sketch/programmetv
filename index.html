<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programme TV TNT</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f0f0f0;
    }

    h1 {
        text-align: center;
        padding: 15px;
    }

    .timeline {
        display: flex;
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 5;
        border-bottom: 1px solid #ccc;
        overflow-x: auto;
    }

    .hour-mark {
        min-width: 100px;
        border-right: 1px solid #ddd;
        padding: 5px;
        text-align: center;
        font-size: 14px;
        background: #fff;
    }

    .grid-container {
        overflow-x: auto;
        overflow-y: visible;
        white-space: nowrap;
        padding-bottom: 50px;
    }

    .channel-row {
        display: flex;
        align-items: stretch;
    }

    .channel-label {
        width: 180px;
        min-width: 180px;
        padding: 10px;
        background: #fff;
        border-right: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        position: sticky;
        left: 0;
        z-index: 3;
        font-weight: bold;
    }

    .program {
    border: 1px solid #3333;
    color: #fff;
    padding: 10px;
    margin: 1px;
    white-space: normal;
    height: 45px;
    overflow: hidden;
    cursor: pointer;

    display: inline-block;

    /* üîß corrections essentielles */
    flex-shrink: 0;
    flex-grow: 0;
    flex-basis: auto;
}


    /* Adaptation mobile */
    @media (max-width: 600px) {
        .hour-mark {
            min-width: 70px;
            font-size: 10px;
        }
        .channel-label {
            width: 120px;
            min-width: 120px;
            font-size: 12px;
            padding-left: 8px;
        }
        .program {
            font-size: 11px;
            padding: 5px;
            height: 36px;
        }
        .grid-container {
            overflow-x: scroll;
            -webkit-overflow-scrolling: touch;
        }
    }

    /* Bouton "Maintenant" */
    #now-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999;
        padding: 10px 15px;
        border-radius: 8px;
        background: #4a6f96;
        color: white;
        border: none;
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        cursor: pointer;
        font-size: 14px;
    }
</style>
</head>
<body>

<h1>Programme TV ‚Äì TNT</h1>

<button id="now-btn" onclick="scrollToNow()">‚è± Maintenant</button>

<div class="timeline" id="timeline"></div>

<div class="grid-container">
    <div id="epg-grid"></div>
</div>

<script>
/* ----------------------------
   CONFIG
-----------------------------*/
const XMLTV_URL = "./xmltv_tnt.xml";
const PIXELS_PER_MINUTE = 2;
const START_HOUR = 6;
const END_HOUR = 24;

/* Styles par cat√©gories */
const CATEGORY_STYLE = {
    "Film":        { emoji: "üé¨", color: "#2d4a7c" },
    "Cin√©ma":      { emoji: "üé¨", color: "#2d4a7c" },

    "S√©rie":       { emoji: "üì∫", color: "#5b3c78" },
    "TV Series":   { emoji: "üì∫", color: "#5b3c78" },

    "Information": { emoji: "üì∞", color: "#7c2d2d" },
    "Journal":     { emoji: "üì∞", color: "#7c2d2d" },

    "Talk":        { emoji: "üí¨", color: "#8c4c1b" },
    "D√©bat":       { emoji: "üí¨", color: "#8c4c1b" },

    "Divertissement": { emoji: "üé≠", color: "#8c1b6a" },
    "Jeu":            { emoji: "üé≠", color: "#8c1b6a" },

    "Jeunesse":    { emoji: "üë∂", color: "#4c7c2d" },

    "Sport":       { emoji: "‚öΩ", color: "#1b6a2d" },

    "Documentaire": { emoji: "üìö", color: "#6a4c2d" },
    "Culture":      { emoji: "üìö", color: "#6a4c2d" }
};

/* Trouver couleur + emoji */
function getStyleFromCategory(category) {
    if (!category) return { emoji: "‚ùì", color: "#555" };
    for (let key in CATEGORY_STYLE) {
        if (category.toLowerCase().includes(key.toLowerCase()))
            return CATEGORY_STYLE[key];
    }
    return { emoji: "‚ùì", color: "#555" };
}

/* ----------------------------
   INIT
-----------------------------*/
async function init() {
    const timeline = document.getElementById("timeline");

    for (let i = START_HOUR; i < END_HOUR; i++) {
        timeline.innerHTML += `<div class="hour-mark">${i}h00</div>`;
    }

    const data = await getEPG();
    if (data) render(data);
}

/* ----------------------------
   LOAD XMLTV
-----------------------------*/
async function getEPG() {
    try {
        const response = await fetch(XMLTV_URL);
        const text = await response.text();

        const parser = new DOMParser();
        const xml = parser.parseFromString(text, "text/xml");

        const programs = xml.querySelectorAll("programme");
        const channels = {};

        programs.forEach(p => {
            const channel = p.getAttribute("channel");
            if (!channels[channel]) channels[channel] = [];

            const start = parseDate(p.getAttribute("start"));
            const stop  = parseDate(p.getAttribute("stop"));
            const startMinutes = start.getHours() * 60 + start.getMinutes();
            const duration = (stop - start) / 60000;

            const categoryNode = p.querySelector("category");
            const category = categoryNode ? categoryNode.textContent : "";

            // On ignore les programmes avant 6h
            if (start.getHours() < START_HOUR) return;

            channels[channel].push({
                title: p.querySelector("title")?.textContent || "Sans titre",
                desc: p.querySelector("desc")?.textContent || "",
                category,
                duration,
                start: (start.getHours() - START_HOUR) * 60 + start.getMinutes()
            });
        });

        return channels;

    } catch (err) {
        document.getElementById("epg-grid").innerText =
            "Erreur : impossible de charger les donn√©es TV";
        console.error(err);
        return null;
    }
}

/* ----------------------------
   XMLTV date format
-----------------------------*/
function parseDate(str) {
    const year  = str.substring(0,4);
    const month = str.substring(4,6);
    const day   = str.substring(6,8);

    const h  = str.substring(8,10);
    const m  = str.substring(10,12);
    const s  = str.substring(12,14);

    const tz = str.substring(15,18) + ":" + str.substring(18);

    return new Date(`${year}-${month}-${day}T${h}:${m}:${s}${tz}`);
}

/* ----------------------------
   RENDER
-----------------------------*/
function render(data) {
    const grid = document.getElementById("epg-grid");
    grid.innerHTML = "";

    Object.keys(data).forEach(channel => {
        let row = `<div class="channel-row">
            <div class="channel-label">${channel}</div>
        `;

        data[channel].forEach(p => {
            const style = getStyleFromCategory(p.category);

            row += `
                <div class="program"
                     style="width:${p.duration * PIXELS_PER_MINUTE}px; background:${style.color};"
                     onclick="alert('${p.title.replace(/'/g,"\\'")}\n\n${p.desc.replace(/'/g,"\\'")}')"
                >
                    ${style.emoji} ${p.title}
                </div>
            `;
        });

        row += "</div>";
        grid.innerHTML += row;
    });
}

/* ----------------------------
   BOUTON "MAINTENANT"
-----------------------------*/
function scrollToNow() {
    const now = new Date();
    let minutes = (now.getHours() - START_HOUR) * 60 + now.getMinutes();
    if (minutes < 0) minutes = 0;

    document.querySelector('.grid-container').scrollTo({
        left: minutes * PIXELS_PER_MINUTE,
        behavior: "smooth"
    });
}

/* GO */
init();
</script>

</body>
</html>

