<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Guide TV TNT Réel</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; margin: 0; }
        .header { position: sticky; top: 0; background: #222; z-index: 100; padding: 10px; border-bottom: 2px solid #444; }
        .timeline { display: flex; margin-left: 150px; position: relative; height: 30px; align-items: center; border-bottom: 1px solid #555; }
        .hour-mark { min-width: 120px; font-size: 12px; color: #aaa; border-left: 1px solid #444; padding-left: 5px; }
        .grid-container { overflow-x: auto; white-space: nowrap; padding-bottom: 20px; }
        .channel-row { display: flex; height: 60px; align-items: center; border-bottom: 1px solid #333; width: max-content; }
        .channel-label { width: 150px; min-width: 150px; position: sticky; left: 0; background: #222; font-weight: bold; z-index: 10; height: 100%; display: flex; align-items: center; padding-left: 15px; border-right: 2px solid #444; }
        .program { background: #3c5a7a; border: 1px solid #5078a0; margin: 2px; border-radius: 4px; padding: 8px; overflow: hidden; text-overflow: ellipsis; cursor: pointer; transition: background 0.2s; font-size: 13px; display: inline-block; vertical-align: top; height: 40px; }
        .program:hover { background: #4a6f96; }
    </style>
</head>
<body>
    <div class="header"><h1>Guide TNT France Moi</h1></div>
    <div class="grid-container">
        <div class="timeline" id="timeline"></div>
        <div id="epg-grid">Chargement des programmes réels...</div>
    </div>

    <script>
       
    const XMLTV_URL = "https://xmltvfr.fr/xmltv/xmltv_tnt.xml";
    const PIXELS_PER_MINUTE = 2;

    async function init() {
        const timeline = document.getElementById('timeline');
        for (let i = 0; i < 24; i++)
            timeline.innerHTML += `<div class="hour-mark">${i}h00</div>`;

        let data = await getEPG();
        if (data) render(data);
    }

    async function getEPG() {
        try {
            const response = await fetch(XMLTV_URL);
            const text = await response.text();

            const parser = new DOMParser();
            const xml = parser.parseFromString(text, "text/xml");

            const channels = {};
            const programs = xml.querySelectorAll("programme");

            programs.forEach(p => {
                const channelId = p.getAttribute("channel");
                if (!channels[channelId]) channels[channelId] = [];

                const start = parseDate(p.getAttribute("start"));
                const stop  = parseDate(p.getAttribute("stop"));
                const duration = (stop - start) / 60000;

                channels[channelId].push({
                    title: p.querySelector("title")?.textContent || "Sans titre",
                    desc:  p.querySelector("desc")?.textContent || "Aucune description disponible.",
                    duration,
                    start: start.getHours() * 60 + start.getMinutes()
                });
            });

            return channels;

        } catch (e) {
            document.getElementById('epg-grid').innerText = "Erreur : impossible de charger les données TV";
            console.error(e);
            return null;
        }
    }

    function parseDate(str) {
    // format: 20240215065500 +0100
    const datePart = str.substring(0, 8);
    const timePart = str.substring(8, 14);
    const tzPart   = str.substring(15);

    const y = datePart.substring(0, 4);
    const m = datePart.substring(4, 6) - 1;
    const d = datePart.substring(6, 8);

    const h   = timePart.substring(0, 2);
    const min = timePart.substring(2, 4);
    const sec = timePart.substring(4, 6);

    return new Date(`${y}-${m+1}-${d}T${h}:${min}:${sec}${formatTZ(tzPart)}`);
}

function formatTZ(tz) {
    return tz.substring(0, 3) + ":" + tz.substring(3);
}


    function render(data) {
        const grid = document.getElementById("epg-grid");
        grid.innerHTML = "";

        Object.keys(data).forEach(channel => {
            let row = `<div class="channel-row"><div class="channel-label">${channel}</div>`;
            data[channel].forEach(p => {
                row += `<div class="program" style="width:${p.duration * PIXELS_PER_MINUTE}px" onclick="alert('${p.desc.replace(/'/g, "\\'")}')">${p.title}</div>`;
            });
            grid.innerHTML += row + "</div>";
        });
    }

    init();
</script>
</body>

</html>

